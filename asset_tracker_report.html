<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asset Tracker</title>
  
  <!-- React and ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  
  <!-- Babel for JSX support -->
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- br-sonoma Font from CDN -->
  <link href="https://fonts.cdnfonts.com/css/br-sonoma" rel="stylesheet">
  
  <!-- Configure Tailwind -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'br-sonoma': ['br-sonoma', 'sans-serif'],
          },
          backgroundImage: {
            'gradient-custom': 'linear-gradient(135deg, #f2d0c4 0%, #d9b8e0 35%, #b5c8e6 70%, #8cbecf 100%)',
          },
          colors: {
            'amber-light': '#f7ebd6',
          }
        }
      }
    }
  </script>
</head>

<body class="bg-gradient-custom font-br-sonoma text-sm">
  <!-- React Root -->
  <div id="root"></div>
  
  <!-- React Application -->
  <script type="text/babel">
    // Main Application Component
    function AssetTracker() {
      // State for application data
      const [lookupData, setLookupData] = React.useState({
        setCodes: [],
        setNameMap: {}
      });
      const [selectedCode, setSelectedCode] = React.useState('');
      const [setName, setSetName] = React.useState('');
      const [items, setItems] = React.useState([]);
      const [expenditure, setExpenditure] = React.useState({
        total: 0,
        asset: 0,
        inventory: 0
      });
      const [loading, setLoading] = React.useState(false);
      const [status, setStatus] = React.useState({ message: '', type: '' });
      const [expanded, setExpanded] = React.useState(false);
      
      // Format currency for display
      const formatCurrency = (value) => {
        return new Intl.NumberFormat('en-AU', { 
          style: 'currency', 
          currency: 'AUD',
          minimumFractionDigits: 2 
        }).format(value);
      };
      
      // Load lookup data on component mount
      React.useEffect(() => {
        fetchLookupData();
      }, []);
      
      // Fetch lookup data from Google Apps Script
      const fetchLookupData = () => {
        showStatus("Fetching dropdown data...", "info");
        setLoading(true);
        
        // Call Google Apps Script function
        google.script.run
          .withSuccessHandler((data) => {
            console.log("Data received:", data);
            setLoading(false);
            
            if (!data || !data.success) {
              showStatus("API returned error: " + (data.error || "Unknown error"), "error");
              return;
            }
            
            if (!data.buyerList || !data.setCodes) {
              showStatus("API returned incomplete data", "error");
              return;
            }
            
            setLookupData({
              setCodes: data.setCodes || [],
              setNameMap: data.setNameMap || {}
            });
            
            showStatus(`Successfully loaded ${data.setCodes.length} set codes`, "success");
          })
          .withFailureHandler((error) => {
            console.error("Error fetching lookup data:", error);
            setLoading(false);
            showStatus("Error loading dropdown data: " + error.message, "error");
          })
          .getLookupLists();
      };
      
      // Load data when set code changes
      const handleSetCodeChange = (e) => {
        const code = e.target.value;
        setSelectedCode(code);
        
        if (!code) {
          setSetName('');
          setItems([]);
          setExpenditure({ total: 0, asset: 0, inventory: 0 });
          return;
        }
        
        // Set the name from the mapping
        setSetName(lookupData.setNameMap[code] || '');
        
        // Show loading
        setLoading(true);
        
        // Call Google Apps Script to get set code items
        google.script.run
          .withSuccessHandler((result) => {
            setLoading(false);
            
            if (!result.success) {
              showStatus("Error loading data: " + (result.error || "Unknown error"), "error");
              return;
            }
            
            // Set items and expenditure data
            setItems(result.items || []);
            setExpenditure({
              total: result.totalExpenditure || 0,
              asset: result.totalAssetExpenditure || 0,
              inventory: result.totalInventoryExpenditure || 0
            });
            
            showStatus(`Successfully loaded data for ${code}`, "success");
          })
          .withFailureHandler((error) => {
            console.error("Error fetching set code data:", error);
            setLoading(false);
            showStatus("Error: " + error.message, "error");
          })
          .getSetCodeItems(code);
      };
      
      // Helper function to show status messages
      const showStatus = (message, type) => {
        setStatus({ message, type });
        
        if (message) {
          setTimeout(() => {
            setStatus({ message: '', type: '' });
          }, 5000);
        }
      };
      
      // Parse date strings in various formats (brought over from legacy code)
      const parseDateString = (dateStr) => {
        if (!dateStr) return new Date(0);
        
        let dateParts;
        
        if (dateStr.includes('/')) {
          dateParts = dateStr.split('/');
          if (dateParts.length === 3) {
            return new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
          }
        }
        
        if (dateStr.includes('-')) {
          dateParts = dateStr.split('-');
          if (dateParts.length === 3) {
            return new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
          }
        }
        
        return new Date(dateStr);
      };
      
      // Calculate analytics data
      const calculateAnalytics = () => {
        if (!items || items.length === 0) return null;
        
        // Calculate buyer breakdown
        const buyerBreakdown = {};
        items.forEach(item => {
          const buyer = item.buyer || 'Unknown';
          const price = parseFloat(item.price.replace(/[^0-9.-]+/g, '')) || 0;
          
          if (!buyerBreakdown[buyer]) {
            buyerBreakdown[buyer] = {
              name: buyer,
              total: 0,
              count: 0
            };
          }
          
          buyerBreakdown[buyer].total += price;
          buyerBreakdown[buyer].count += 1;
        });
        
        const topBuyers = Object.values(buyerBreakdown).sort((a, b) => b.total - a.total);
        
        // Calculate purchase type breakdown
        const typeBreakdown = {};
        items.forEach(item => {
          const type = item.purchaseType || 'Unknown';
          const price = parseFloat(item.price.replace(/[^0-9.-]+/g, '')) || 0;
          
          if (!typeBreakdown[type]) {
            typeBreakdown[type] = {
              name: type,
              total: 0,
              count: 0
            };
          }
          
          typeBreakdown[type].total += price;
          typeBreakdown[type].count += 1;
        });
        
        const purchaseTypes = Object.values(typeBreakdown).sort((a, b) => b.total - a.total);
        
        // Calculate date range
        let oldestDate = new Date();
        let newestDate = new Date(0);
        
        items.forEach(item => {
          if (!item.purchaseDate) return;
          
          const date = parseDateString(item.purchaseDate);
          if (date < oldestDate) oldestDate = date;
          if (date > newestDate) newestDate = date;
        });
        
        // Format date range for display
        const dateRangeDisplay = `${oldestDate.toLocaleDateString()} - ${newestDate.toLocaleDateString()}`;
        
        return {
          topBuyers,
          purchaseTypes,
          dateRangeDisplay
        };
      };
      
      const analytics = calculateAnalytics();
      
      // Sort items by date (newest first)
      const sortedItems = React.useMemo(() => {
        if (!items || items.length === 0) return [];
        
        return [...items].sort((a, b) => {
          const dateA = parseDateString(a.purchaseDate);
          const dateB = parseDateString(b.purchaseDate);
          
          return dateB - dateA;
        });
      }, [items]);
      
      return (
        <div className="min-h-screen p-6 flex justify-center">
          <div className="max-w-7xl w-full bg-transparent border border-gray-300 rounded-2xl shadow-lg p-6 min-h-[calc(100vh-3rem)]">
            {/* Header */}
            <div className="flex justify-between items-start mb-6">
              <div>
                <img 
                  src="https://drive.google.com/uc?export=view&id=1lClYTeDjY2RqB9ia23brgtjEMTVEmu59" 
                  alt="Spacemouse Logo" 
                  className="max-w-[160px]"
                />
              </div>
              <div className="text-right text-sm leading-tight">
                <p>Servo Productions 10 Pty Ltd "SPACEMOUSE"</p>
                <p>ABN: 96 671 510 884</p>
                <p>Village Roadshow Studios, Production Area 1</p>
                <p>Entertainment Rd OXENFORD QLD 4210 Australia</p>
              </div>
            </div>
            
            {/* Control Row */}
            <div className="flex flex-wrap gap-4 mb-6">
              {/* Department Dropdown */}
              <div className="relative">
                <select
                  value="SET DEC"
                  disabled={true}
                  className="appearance-none bg-white border border-gray-200 rounded-xl px-4 py-2 pr-8 
                             focus:outline-none focus:ring-2 focus:ring-blue-300 focus:border-transparent text-sm"
                >
                  <option>SET DEC</option>
                </select>
                <div className="absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
                  <svg width="10" height="6" viewBox="0 0 10 6" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M1 1L5 5L9 1" stroke="#6B7280" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                </div>
              </div>
              
              {/* Set Code Dropdown */}
              <div className="relative">
                <select
                  value={selectedCode}
                  onChange={handleSetCodeChange}
                  className="appearance-none bg-white border border-gray-300 rounded-xl px-4 py-2 pr-8 
                             focus:outline-none focus:ring-2 focus:ring-blue-300 focus:border-transparent text-sm"
                >
                  <option value="">Select a code</option>
                  {lookupData.setCodes.map(code => (
                    <option key={code} value={code}>{code}</option>
                  ))}
                </select>
                <div className="absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
                  <svg width="10" height="6" viewBox="0 0 10 6" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M1 1L5 5L9 1" stroke="#6B7280" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                </div>
              </div>
              
              {/* Set Name Input */}
              <input
                type="text"
                value={setName}
                readOnly
                placeholder="Set Name"
                className="bg-white border border-gray-300 rounded-xl px-4 py-2 
                          focus:outline-none focus:ring-2 focus:ring-blue-300 focus:border-transparent 
                          text-sm bg-gray-50 min-w-[300px]"
              />
            </div>
            
            {/* Data Table */}
            <div className="relative border border-gray-300 rounded-xl overflow-hidden bg-white shadow-sm">
              {/* Table Header */}
              <div className="bg-gray-100 flex border-b border-gray-300 text-gray-600 font-medium">
                <div className="w-[10%] py-3 px-4">Asset</div>
                <div className="w-[10%] py-3 px-4 text-center">Date</div>
                <div className="w-[34%] py-3 px-4">Item Description</div>
                <div className="w-[12%] py-3 px-4 text-right">Price (NET)</div>
                <div className="w-[8%] py-3 px-4 text-center">Type</div>
                <div className="w-[11%] py-3 px-4 text-center">Transaction ID</div>
                <div className="w-[15%] py-3 px-4">Buyer</div>
              </div>
              
              {/* Table Content */}
              <div className="max-h-[27rem] overflow-y-auto"> {/* previous max-h-96 */}
                {sortedItems.length === 0 ? (
                  <div className="p-8 text-center text-gray-500 italic">
                    Select a Set Code to view items
                  </div>
                ) : (
                  sortedItems.map((item, index) => {
                    // Format price with two decimal places and thousand separators
                    let formattedPrice = "";
                    if (item.price) {
                      const numericPrice = parseFloat(item.price.replace(/[^0-9.-]+/g, ""));
                      if (!isNaN(numericPrice)) {
                        formattedPrice = new Intl.NumberFormat('en-AU', {
                          minimumFractionDigits: 2,
                          maximumFractionDigits: 2,
                          useGrouping: true
                        }).format(numericPrice);
                      } else {
                        formattedPrice = item.price;
                      }
                    }
                    
                    return (
                      <div 
                        key={index}
                        className={`flex border-b border-gray-300 ${index % 2 === 1 ? 'bg-gray-100' : ''}`} //alternating row colour shade
                      >
                        <div className="w-[10%] py-3 px-4">{item.asset || ""}</div>
                        <div className="w-[10%] py-3 px-4 text-center">{item.purchaseDate || ""}</div>
                        <div className="w-[34%] py-3 px-4 truncate">{item.itemDescription || ""}</div>
                        <div className="w-[12%] py-3 px-4 text-right">
                          <span className="relative pl-3 inline-block">
                            <span className="absolute left-0 top-0">$</span>
                            {formattedPrice}
                          </span>
                        </div>
                        <div className="w-[8%] py-3 px-4 text-center">{item.purchaseType || ""}</div>
                        <div className="w-[11%] py-3 px-4 text-center">{item.transactionId || ""}</div>
                        <div className="w-[15%] py-3 px-4">{item.buyer || ""}</div>
                      </div>
                    );
                  })
                )}
              </div>
              
              {/* Loading Overlay */}
              {loading && (
                <div className="absolute inset-0 flex items-center justify-center bg-white/80 z-10">
                  <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                </div>
              )}
            </div>
            
            {/* Analytics Panel */}
            {items.length > 0 && analytics && (
              <div className="bg-transparent rounded-xl p-4 mt-4">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="font-bold text-gray-700">Asset Analysis</h3>
                  <button
                    className="flex items-center gap-1 text-blue-600 text-sm focus:outline-none"
                    onClick={() => setExpanded(!expanded)}
                  >
                    {expanded ? 'Hide Details' : 'Show Details'}
                    <svg 
                      width="12" 
                      height="6" 
                      viewBox="0 0 12 6" 
                      fill="none" 
                      xmlns="http://www.w3.org/2000/svg"
                      className={`transition-transform duration-200 ${expanded ? 'rotate-180' : ''}`}
                    >
                      <path d="M1 1L6 5L11 1" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                    </svg>
                  </button>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                  <div className="bg-amber-light rounded-xl p-3 shadow-sm">
                    <div className="text-gray-500 text-xs mb-1">Total Set Cost</div>
                    <div className="font-bold text-blue-800 text-lg">{formatCurrency(expenditure.total)}</div>
                  </div>
                  
                  <div className="bg-white rounded-xl p-3 shadow-sm">
                    <div className="text-gray-500 text-xs mb-1">Total Asset Cost</div>
                    <div className="font-bold text-blue-800 text-lg">{formatCurrency(expenditure.asset)}</div>
                  </div>
                  
                  <div className="bg-white rounded-xl p-3 shadow-sm">
                    <div className="text-gray-500 text-xs mb-1">Total Inventory Cost</div>
                    <div className="font-bold text-blue-800 text-lg">{formatCurrency(expenditure.inventory)}</div>
                  </div>
                  
                  <div className="bg-white rounded-xl p-3 shadow-sm">
                    <div className="text-gray-500 text-xs mb-1">Date Range</div>
                    <div className="font-bold text-blue-800 text-base">{analytics.dateRangeDisplay}</div>
                  </div>
                </div>
                
                {expanded && (
                  <div className="mt-4">
                    <h4 className="font-medium text-gray-700 text-sm mb-2">Top Buyers</h4>
                    <div className="flex gap-4 overflow-x-auto pb-2">
                      {analytics.topBuyers.map((buyer, index) => (
                        <div key={index} className="bg-white p-3 rounded-xl border border-gray-200 shadow-sm min-w-32 shrink-0">
                          <div className="text-gray-500 text-xs mb-1">{buyer.name}</div>
                          <div className="font-bold text-blue-800 text-base">{formatCurrency(buyer.total)}</div>
                          <div className="text-gray-400 text-xs">{buyer.count} items</div>
                        </div>
                      ))}
                    </div>
                    
                    <h4 className="font-medium text-gray-700 text-sm mt-4 mb-2">Purchase Type Breakdown</h4>
                    <div className="flex gap-4 overflow-x-auto pb-2">
                      {analytics.purchaseTypes.map((type, index) => (
                        <div key={index} className="bg-white p-3 rounded-xl border border-gray-200 shadow-sm min-w-32 shrink-0">
                          <div className="text-gray-500 text-xs mb-1">{type.name}</div>
                          <div className="font-bold text-blue-800 text-base">{formatCurrency(type.total)}</div>
                          <div className="text-gray-400 text-xs">{type.count} items</div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}
            
            {/* Status Message */}
            {status.message && (
              <div className={`p-3 rounded-lg border mt-4 text-center text-sm ${
                status.type === 'success' ? 'bg-green-100 border-green-400 text-green-800' : 
                status.type === 'error' ? 'bg-red-100 border-red-400 text-red-800' : 
                'bg-blue-100 border-blue-400 text-blue-800'
              }`}>
                {status.message}
              </div>
            )}
          </div>
        </div>
      );
    }
    
    // Render the application
    ReactDOM.render(
      <AssetTracker />,
      document.getElementById('root')
    );
  </script>
</body>
</html>